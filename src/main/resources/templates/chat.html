<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì±„íŒ…</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        #chat-popup {
          position: fixed; bottom: 80px; right: 30px;
          width: 320px; height: 420px; display: none;
          flex-direction: column; background: white;
          border-radius: 10px; border: 1px solid #ccc;
          box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        #chat-header { padding: 10px; background: #f2f2f2; font-weight: bold; border-bottom: 1px solid #ddd; }
        #chat-box { flex: 1; overflow-y: scroll; padding: 10px; }
        .chat-message { margin: 5px 0; max-width: 70%; padding: 8px 12px; border-radius: 15px; }
        .my-message { background-color: #ffeb3b; margin-left: auto; text-align: right; }
        .other-message { background-color: #e0e0e0; margin-right: auto; text-align: left; }
        #chat-input-area { display: flex; padding: 10px; border-top: 1px solid #ccc; }
        #message-input { flex: 1; padding: 8px; }
        #chat-button {
          position: fixed; bottom: 20px; right: 30px;
          width: 60px; height: 60px; border-radius: 50%;
          font-size: 24px; background: #ffeb3b;
          border: none; cursor: pointer;
        }
        #emoji-panel {
          display: flex; flex-wrap: wrap; padding: 5px;
          border-top: 1px solid #ccc; max-height: 100px; overflow-y: auto;
        }
        .emoji { cursor: pointer; font-size: 22px; padding: 5px; }
    </style>
</head>
<body>

<!-- ì±„íŒ… ë¡œê³  ë²„íŠ¼ -->
<button id="chat-button">ğŸ’¬</button>

<!-- íŒì—… ì±„íŒ…ì°½ -->
<div id="chat-popup">
    <div id="chat-header">ì±„íŒ…ë°©</div>
    <div id="chat-box"></div>
    <div id="emoji-panel">
        <span class="emoji">ğŸ˜€</span>
        <span class="emoji">ğŸ˜‚</span>
        <span class="emoji">ğŸ˜</span>
        <span class="emoji">ğŸ˜¢</span>
        <span class="emoji">ğŸ‘</span>
        <span class="emoji">ğŸ‘</span>
        <span class="emoji">ğŸ’¡</span>
        <span class="emoji">ğŸ‰</span>
        <span class="emoji">â¤ï¸</span>
    </div>
    <div id="chat-input-area">
        <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." />
        <button onclick="sendMessage()">ğŸ“©</button>
    </div>
</div>

<script>
    // JWTì—ì„œ ì‚¬ìš©ì ì´ë¦„ ì¶”ì¶œ
    function parseJwt(token) {
      try {
        const base64Payload = token.split('.')[1];
        return JSON.parse(atob(base64Payload));
      } catch (e) {
        return null;
      }
    }

    const token = localStorage.getItem("token");
    const decoded = parseJwt(token);
    const username = decoded?.sub;

    if (!token || !username) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      window.location.href = "/login"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (í•„ìš” ì‹œ)
    }

    // URLì—ì„œ eventId ì¶”ì¶œ
    const urlParts = window.location.pathname.split("/");
    const currentEventId = urlParts[urlParts.length - 1];

    let stompClient = null;

    document.getElementById("chat-button").onclick = () => {
      document.getElementById("chat-popup").style.display = "flex";

      const socket = new SockJS("/ws-chat");
      stompClient = Stomp.over(socket);

      stompClient.connect(
        { Authorization: 'Bearer ' + token },
        () => {
          stompClient.subscribe("/topic/chatroom/" + currentEventId, (message) => {
            const msg = JSON.parse(message.body);
            renderMessage(msg);
          });

          stompClient.subscribe("/user/queue/history", (message) => {
            let messages = JSON.parse(message.body);
            if (Array.isArray(messages)) messages.forEach(renderMessage);
          });

          stompClient.subscribe("/user/queue/warning", (message) => {
            const warning = JSON.parse(message.body);
            alert(warning.message);
          });

          setTimeout(() => {
            stompClient.send("/app/chat.loadHistory/" + currentEventId, {}, currentEventId);
          }, 200);
        },
        (error) => {
          console.error("ì—°ê²° ì‹¤íŒ¨", error);
        }
      );
    };

    function sendMessage(content) {
      const msg = content || document.getElementById("message-input").value.trim();
      if (!msg || !stompClient || !stompClient.connected) return;

      stompClient.send("/app/chat.sendMessage/" + currentEventId, {}, JSON.stringify({ message: msg }));
      document.getElementById("message-input").value = "";
    }

    function renderMessage(msg) {
      const chatBox = document.getElementById("chat-box");
      const div = document.createElement("div");
      const isMine = msg.sender === username;
      div.className = `chat-message ${isMine ? "my-message" : "other-message"}`;
      div.textContent = isMine ? msg.message : `${msg.sender}: ${msg.message}`;
      div.setAttribute("data-timestamp", msg.timestamp);

      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    document.querySelectorAll(".emoji").forEach(emoji => {
      emoji.addEventListener("click", () => {
        const input = document.getElementById("message-input");
        input.value += emoji.textContent;
        input.focus();
      });
    });

    // 10ë¶„ ì§€ë‚˜ë©´ ìë™ ì œê±°
    setInterval(() => {
      const chatBox = document.getElementById("chat-box");
      const now = new Date();
      Array.from(chatBox.children).forEach(div => {
        const timestamp = div.getAttribute("data-timestamp");
        if (!timestamp) return;
        const time = new Date(timestamp);
        const diffMinutes = (now - time) / (1000 * 60);
        if (diffMinutes > 10) {
          div.remove();
        }
      });
    }, 30 * 1000);
</script>


</body>
</html>
